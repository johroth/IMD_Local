#!/bin/bash
#
#########################################
# Convert IMD-chkpt format              #
# to multiple copies of IMD-chkpt       #
#                                       #
# 08.11.2002 Ulrich Koschella           #
# 09.09.2003 Peter Brommer              #
# 07.03.2006 Peter Brommer              #
#                                       #
# Usage:                                #
# imd2imd <infile> <outfile> <i> <j> <k>#
#     reads infile, writes to           #
#     outfile (i*j*k copies)            #
#########################################
# $Revision$                     #
# $Date$          #
#########################################

if [ \( "$#" -ne 5 \) ] ; then
  echo "Usage:" 1>&2
  echo " " 1>&2
  echo "imd2imd <infile> <outfile> <i> <j> <k>" 1>&2
  exit 1
fi

fout="$2"

if [ ! -e $1 ] ; then 
    echo "$1 does not exist. Exiting." 1>&2
    exit 2;
fi

if [ -d $1 ] ; then 
    echo "$1 is a directory. Exiting." 1>&2
    exit 2;
fi

if [ -e "$fout" ] ; then
  if [ -d "$fout" ] ; then
    echo "$fout exists and is a directory." 1>&2
    echo "Exiting." 1>&2
    exit 2
  else
    echo -n "$fout exists. Overwrite? (y/n) "
    read answ
    if [ "$answ" != "y" ] ; then
      exit 2
    fi
    rm -f $fout
  fi
fi



if [ \( "$3" -gt 0 \) -a  \( "$4" -gt 0 \) -a  \( "$5" -gt 0 \) ] ; then
   xdim=$3
   ydim=$4
   zdim=$5
else
   echo "<i> <j> <k> must be greater than 0"
fi

d=`date`

echo "#F A 1 1 1 3 0 0" >$2
echo "#C number type mass x y z" >>$2
awk -v xdim="$xdim"  -v ydim="$ydim" -v zdim="$zdim"  '\
     BEGIN {CONVFMT="%.7f"; OFMT="%.7f"}\
     (/#X/) {print $1 "     " $2*xdim " " $3*xdim " " $4*xdim} \
     (/#Y/) {print $1 "     " $2*ydim " " $3*ydim " " $4*ydim} \
     (/#Z/) {print $1 "     " $2*zdim " " $3*zdim " " $4*zdim;exit}\
     '  $1 >>$2
echo "## Generated by imd2imd on $d" >>$2
echo "#E" >>$2
atoms=$(grep -v \^# $1 | wc -l)

for (( k=0 ; k<zdim ; k=k+1 )) ; do
    for (( j=0 ; j<ydim ; j=j+1 )) ;  do
        for (( i=0 ; i<xdim ; i=i+1 )) ;  do
	    awk -v xdim="$xdim"  -v ydim="$ydim" -v zdim="$zdim" \
		-v at="$atoms" -v i="$i" -v j="$j" -v k="$k"  '\
      BEGIN {CONVFMT="%.7f"; OFMT="%.7f"; ORS=""; anr=(i+xdim*(j+ydim*k))*at}\
     (/#X/) {cell[1,1]=$2; cell[1,2]=$3; cell[1,3]=$4}\
     (/#Y/) {cell[2,1]=$2; cell[2,2]=$3; cell[2,3]=$4}\
     (/#Z/) {cell[3,1]=$2; cell[3,2]=$3; cell[3,3]=$4}\
     (!/#/)  {print $1+anr " " $2 " " $3 " ";\
              print $4+cell[1,1]*i+cell[2,1]*j+cell[3,1]*k " ";\
              print $5+cell[1,2]*i+cell[2,2]*j+cell[3,2]*k " ";\
              print $6+cell[1,3]*i+cell[2,3]*j+cell[3,3]*k "\n"}' $1 >>$2
	done
    done
done

